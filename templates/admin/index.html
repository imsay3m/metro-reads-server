{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Dashboard | Metro Reads Admin{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 1. THEME DEFINITION USING CSS VARIABLES */
        :root {
            --card-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #eeeeee;
            --overdue-color: #ba2121;
            --chart-bg-color: rgba(44, 90, 160, 0.5);
            --chart-border-color: rgba(44, 90, 160, 1);
        }

        /* 2. DARK MODE PALETTE (Works with OS setting AND manual toggle) */
        @media (prefers-color-scheme: dark) {
            :root { --card-bg: #292c2d; --text-primary: #e0e0e0; --text-secondary: #a0a0a0; --border-color: #444; --overdue-color: #ff5555; --chart-bg-color: rgba(93, 156, 236, 0.5); --chart-border-color: rgba(93, 156, 236, 1); }
        }
        body.theme-dark { --card-bg: #292c2d; --text-primary: #e0e0e0; --text-secondary: #a0a0a0; --border-color: #444; --overdue-color: #ff5555; --chart-bg-color: rgba(93, 156, 236, 0.5); --chart-border-color: rgba(93, 156, 236, 1); }

        /* 3. APPLYING THE VARIABLES */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-top: 20px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .kpi-card, .widget-card { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); }
        .kpi-card h3 { margin: 0 0 10px 0; color: var(--text-secondary); font-size: 1.2rem; font-weight: normal; }
        .kpi-card p { margin: 0; font-size: 2.5rem; font-weight: bold; color: var(--text-primary); }
        .kpi-card p.overdue { color: var(--overdue-color); }
        .widget-card h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 0; font-size: 1.3rem; color: var(--text-primary); }
        .widget-card ul { list-style: none; padding: 0; margin: 0; }
        .widget-card li { padding: 8px 0; border-bottom: 1px solid var(--border-color); color: var(--text-secondary); }
        .widget-card li:last-child { border-bottom: none; }
        .widget-card li strong { color: var(--text-primary); }
    </style>
{% endblock %}

{% block content_title %}<h1>Metro Reads Dashboard</h1>{% endblock %}

{% block content %}
<div id="content-main">
    <!-- KPIs Section -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <h3>Total Members</h3>
            <p>{{ total_members|default:"0" }}</p>
        </div>
        <div class="kpi-card">
            <h3>Active Loans</h3>
            <p>{{ active_loans|default:"0" }}</p>
        </div>
        <div class="kpi-card">
            <h3>Overdue Books</h3>
            <p class="overdue">{{ overdue_books|default:"0" }}</p>
        </div>
        <div class="kpi-card">
            <h3>Books with Queues</h3>
            <p>{{ books_with_queues|default:"0" }}</p>
        </div>
    </div>

    <!-- Main Widgets Grid -->
    <div class="dashboard-grid">
        <div class="widget-card">
            <h3>Loans This Week</h3>
            {% if total_loans_this_week > 0 %}
                <canvas id="loansChart"></canvas>
            {% else %}
                <p style="text-align: center; color: var(--text-secondary); padding-top: 20px;">No loan activity recorded in the last 7 days.</p>
            {% endif %}
        </div>
        <div class="widget-card">
            <h3>Top 5 Longest Queues</h3>
            <ul>
                {% for book in top_queued_books %}<li><strong>{{ book.title }}</strong> ({{ book.active_queue_count }} waiting)</li>{% empty %}<li>No active queues at the moment.</li>{% endfor %}
            </ul>
        </div>
        <div class="widget-card">
            <h3>Top 5 Overdue Loans</h3>
            <ul>
                {% for loan in most_overdue %}<li><strong>{{ loan.book.title }}</strong><br /><small>Loaned by: {{ loan.user.email }} | Due: {{ loan.due_date| date:"Y-m-d" }}</small></li>{% empty %}<li>No overdue loans. Great job!</li>{% endfor %}
            </ul>
        </div>
        <div class="widget-card">
            <h3>Recently Returned</h3>
            <ul>
                {% for loan in recently_returned %}<li><strong>{{ loan.book.title }}</strong><br /><small>Returned by: {{ loan.user.email }} on {{ loan.return_date| date:"Y-m-d" }}</small></li>{% empty %}<li>No books returned recently.</li>{% endfor %}
            </ul>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        if (document.getElementById('loansChart')) {
            const chartTextColor = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
            const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color');
            const ctx = document.getElementById('loansChart').getContext('2d');
            const loansChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: {{ chart_labels|safe }},
                    datasets: [{
                        label: '# of Loans',
                        data: {{ chart_data|safe }},
                        backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--chart-bg-color'),
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--chart-border-color'),
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1, color: chartTextColor }, grid: { color: gridColor } },
                        x: { ticks: { color: chartTextColor }, grid: { color: gridColor } }
                    },
                    responsive: true,
                    plugins: { legend: { display: false } }
                }
            });
        }
    });
</script>
{% endblock %}